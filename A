-- Services
local Players = game:GetService("Players")
local Teams = game:GetService("Teams")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer

-- Settings
local DEFAULT_HEAD_SIZE_R15 = Vector3.new(1.198, 1.202, 1.198)
local DEFAULT_HEAD_SIZE_R6 = Vector3.new(2, 1, 1)
local DEFAULT_KEY = Enum.KeyCode.LeftAlt
local keybind = DEFAULT_KEY
local ignoredTeams = {}
local fullBrightEnabled = false
local teamDropdownOpen = false

-- Variables
local function getDefaultHeadSize()
	local char = LocalPlayer.Character
	if char and char:FindFirstChild("Humanoid") then
		return char.Humanoid.RigType == Enum.HumanoidRigType.R15 and DEFAULT_HEAD_SIZE_R15 or DEFAULT_HEAD_SIZE_R6
	end
	return DEFAULT_HEAD_SIZE_R15
end

local defaultHeadSize = getDefaultHeadSize()
local headModEnabled = false

-- GUI
local gui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
gui.Name = "ClientESP_UI"
gui.ResetOnSpawn = false

-- Open Button
local openButton = Instance.new("TextButton", gui)
openButton.Size = UDim2.new(0, 100, 0, 40)
openButton.Position = UDim2.new(0, 10, 0, 10)
openButton.Text = "Open Menu"
openButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
openButton.TextColor3 = Color3.new(1, 1, 1)
openButton.Active = true
openButton.Draggable = true

-- Main Menu
local menu = Instance.new("Frame", gui)
menu.Size = UDim2.new(0, 250, 0, 350)
menu.Position = UDim2.new(0, 10, 0, 60)
menu.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
menu.Visible = false
menu.Active = true
menu.Draggable = true

-- Keep GUI on screen
RunService.RenderStepped:Connect(function()
	for _, frame in ipairs({menu, openButton}) do
		if frame.Visible then
			local pos = frame.AbsolutePosition
			local size = frame.AbsoluteSize
			local guiSize = gui.AbsoluteSize
			frame.Position = UDim2.new(0, math.clamp(pos.X, 0, guiSize.X - size.X), 0, math.clamp(pos.Y, 0, guiSize.Y - size.Y))
		end
	end
end)

-- Toggle Menu Keybind
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if not gameProcessed and input.KeyCode == keybind then
		menu.Visible = not menu.Visible
	end
end)

openButton.MouseButton1Click:Connect(function()
	menu.Visible = not menu.Visible
end)

-- GUI Utility
local function createLabel(text, y)
	local lbl = Instance.new("TextLabel", menu)
	lbl.Position = UDim2.new(0, 10, 0, y)
	lbl.Size = UDim2.new(0, 200, 0, 20)
	lbl.BackgroundTransparency = 1
	lbl.TextColor3 = Color3.new(1, 1, 1)
	lbl.Text = text
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	return lbl
end

local function createCheckbox(y, onToggle)
	local box = Instance.new("TextButton", menu)
	box.Size = UDim2.new(0, 20, 0, 20)
	box.Position = UDim2.new(0, 90, 0, y)
	box.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
	box.BorderColor3 = Color3.new(0, 0, 0)
	box.Text = ""
	box.MouseButton1Click:Connect(function()
		local enabled = onToggle()
		box.BackgroundColor3 = enabled and Color3.new(0, 1, 0) or Color3.fromRGB(80, 80, 80)
	end)
	return box
end

local function createSlider(y, min, max, default)
	local frame = Instance.new("Frame", menu)
	frame.Position = UDim2.new(0, 10, 0, y)
	frame.Size = UDim2.new(0, 200, 0, 20)
	frame.BackgroundColor3 = Color3.fromRGB(60, 60, 60)

	local fill = Instance.new("Frame", frame)
	fill.Size = UDim2.new((default - min)/(max - min), 0, 1, 0)
	fill.BackgroundColor3 = Color3.fromRGB(120, 120, 255)

	local value = default
	local dragging = false

	local function update(x)
		local relX = math.clamp((x - frame.AbsolutePosition.X) / frame.AbsoluteSize.X, 0, 1)
		fill.Size = UDim2.new(relX, 0, 1, 0)
		value = min + relX * (max - min)
	end

	frame.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			update(input.Position.X)
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
			update(input.Position.X)
		end
	end)

	UserInputService.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)

	return function() return value end
end

-- Controls
createLabel("Head Mod:", 10)
createCheckbox(10, function()
	headModEnabled = not headModEnabled
	return headModEnabled
end)

local fbCheck = createCheckbox(10, function()
	fullBrightEnabled = not fullBrightEnabled
	return fullBrightEnabled
end)
fbCheck.Position = UDim2.new(0, 150, 0, 10)

createLabel("ESP:", 40)
createCheckbox(40, function()
	espEnabled = not espEnabled
	if not espEnabled then
		for _, child in ipairs(espFolder:GetChildren()) do child:Destroy() end
	end
	return espEnabled
end)

createLabel("Chams:", 70)
createCheckbox(70, function()
	chamsEnabled = not chamsEnabled
	for _, player in ipairs(Players:GetPlayers()) do
		if player.Character then
			for _, part in ipairs(player.Character:GetDescendants()) do
				if part:IsA("BoxHandleAdornment") and part.Name == "ChamBox" then
					part:Destroy()
				end
			end
		end
	end
	return chamsEnabled
end)

createLabel("Head Size:", 100)
local getHeadSize = createSlider(120, 1, 30, defaultHeadSize.X)

createLabel("Transparency:", 150)
local getTransparency = createSlider(170, 0, 1, 0)

-- Keybind Setup
createLabel("Toggle Keybind:", 200)
local keyLabel = Instance.new("TextLabel", menu)
keyLabel.Position = UDim2.new(0, 120, 0, 200)
keyLabel.Size = UDim2.new(0, 100, 0, 20)
keyLabel.Text = keybind.Name
keyLabel.BackgroundTransparency = 1
keyLabel.TextColor3 = Color3.new(1, 1, 1)

local keyBox = Instance.new("TextBox", menu)
keyBox.Position = UDim2.new(0, 10, 0, 230)
keyBox.Size = UDim2.new(0, 200, 0, 25)
keyBox.PlaceholderText = "Press any key..."
keyBox.ClearTextOnFocus = false
keyBox.TextColor3 = Color3.new(1, 1, 1)
keyBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)

keyBox.Focused:Connect(function()
	local conn
	conn = UserInputService.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.Keyboard then
			keybind = input.KeyCode
			keyLabel.Text = keybind.Name
			keyBox:ReleaseFocus()
			conn:Disconnect()
		end
	end)
end)

-- Reset
local resetButton = Instance.new("TextButton", menu)
resetButton.Position = UDim2.new(0, 10, 0, 265)
resetButton.Size = UDim2.new(0, 200, 0, 30)
resetButton.Text = "Reset to Default"
resetButton.BackgroundColor3 = Color3.fromRGB(100, 30, 30)
resetButton.TextColor3 = Color3.new(1, 1, 1)
resetButton.MouseButton1Click:Connect(function()
	headModEnabled = false
	fullBrightEnabled = false
	ignoredTeams = {}
end)

-- Dropdown for ignoring teams
createLabel("Ignore Team (Head):", 305)
local dropdown = Instance.new("TextButton", menu)
dropdown.Size = UDim2.new(0, 200, 0, 25)
dropdown.Position = UDim2.new(0, 10, 0, 325)
dropdown.Text = "Select team to ignore..."
dropdown.TextColor3 = Color3.new(1, 1, 1)
dropdown.BackgroundColor3 = Color3.fromRGB(40, 40, 40)

local function toggleTeamIgnore(teamName)
	if ignoredTeams[teamName] then
		ignoredTeams[teamName] = nil
	else
		ignoredTeams[teamName] = true
	end
end

dropdown.MouseButton1Click:Connect(function()
	teamDropdownOpen = not teamDropdownOpen
	for _, obj in ipairs(menu:GetChildren()) do
		if obj.Name == "TeamOption" then obj:Destroy() end
	end

	if not teamDropdownOpen then return end

	local y = 355
	for _, team in ipairs(Teams:GetTeams()) do
		local btn = Instance.new("TextButton", menu)
		btn.Name = "TeamOption"
		btn.Position = UDim2.new(0, 10, 0, y)
		btn.Size = UDim2.new(0, 200, 0, 20)
		btn.Text = (ignoredTeams[team.Name] and "[✔] " or "[  ] ") .. team.Name
		btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
		btn.TextColor3 = Color3.new(1, 1, 1)
		btn.MouseButton1Click:Connect(function()
			toggleTeamIgnore(team.Name)
			btn.Text = (ignoredTeams[team.Name] and "[✔] " or "[  ] ") .. team.Name
		end)
		y += 25
	end
end)

-- Runtime logic
local function applyHeadMod(player)
	if player == LocalPlayer or ignoredTeams[player.Team and player.Team.Name or ""] then return end
	local char = player.Character
	local head = char and char:FindFirstChild("Head")
	if head then
		local humanoid = char:FindFirstChildOfClass("Humanoid")
		local baseSize = humanoid and (humanoid.RigType == Enum.HumanoidRigType.R15 and DEFAULT_HEAD_SIZE_R15 or DEFAULT_HEAD_SIZE_R6)
		head.Size = baseSize * getHeadSize()
		head.Transparency = getTransparency()
		head.CanCollide = false
		head.Massless = true
	end
end

-- New toggles
local espEnabled = false
local chamsEnabled = false

-- ESP folder for GUI labels
local espFolder = Instance.new("Folder", gui)
espFolder.Name = "ClientESP_Labels"

-- ESP Creation
local function createESP(player)
	if player == LocalPlayer then return end
	local function createLabel()
		if not player.Character or not player.Character:FindFirstChild("Head") then return end

		local billboard = Instance.new("BillboardGui")
		billboard.Name = "ESPLabel"
		billboard.Adornee = player.Character.Head
		billboard.AlwaysOnTop = true
		billboard.Size = UDim2.new(0, 100, 0, 40)
		billboard.StudsOffset = Vector3.new(0, 2, 0)
		billboard.Parent = espFolder

		local label = Instance.new("TextLabel", billboard)
		label.Size = UDim2.new(1, 0, 1, 0)
		label.BackgroundTransparency = 1
		label.TextColor3 = Color3.new(1, 1, 1)
		label.TextStrokeTransparency = 0.5
		label.TextScaled = true
		label.Text = player.Name

		RunService.Heartbeat:Connect(function()
			if not billboard.Parent or not player.Character or not player.Character:FindFirstChild("Humanoid") then return end
			local hp = math.floor(player.Character.Humanoid.Health)
			local max = math.floor(player.Character.Humanoid.MaxHealth)
			label.Text = string.format("%s [%d/%d]", player.Name, hp, max)
		end)
	end

	player.CharacterAdded:Connect(function()
		if espEnabled then
			task.wait(1)
			createLabel()
		end
	end)

	if player.Character and espEnabled then
		createLabel()
	end
end

-- Chams Application
local function applyChams(player)
	if player == LocalPlayer or not player.Character then return end
	for _, part in ipairs(player.Character:GetChildren()) do
		if part:IsA("BasePart") and not part:FindFirstChild("ChamBox") then
			local box = Instance.new("BoxHandleAdornment")
			box.Name = "ChamBox"
			box.Size = part.Size
			box.Adornee = part
			box.AlwaysOnTop = true
			box.ZIndex = 0
			box.Transparency = getTransparency()
			box.AlwaysOnTop = true
			box.Color3 = player.Team and player.Team.TeamColor.Color or Color3.new(0, 1, 0)
			box.Parent = part
		end
	end
end
-- Track all players
local function hookPlayer(p)
	if p == LocalPlayer then return end
	p.CharacterAdded:Connect(function()
		task.wait(1)
		if espEnabled then createESP(p) end
		if chamsEnabled then applyChams(p) end
	end)
	p:GetPropertyChangedSignal("Team"):Connect(function()
	end)
end

for _, p in ipairs(Players:GetPlayers()) do hookPlayer(p) end
Players.PlayerAdded:Connect(hookPlayer)

-- Update loop
RunService.Heartbeat:Connect(function()
	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= LocalPlayer then
			if headModEnabled then pcall(function() applyHeadMod(p) end) end
			if chamsEnabled then pcall(function() applyChams(p) end) end
		end
	end

	if fullBrightEnabled then
		Lighting.Ambient = Color3.new(1, 1, 1)
		Lighting.OutdoorAmbient = Color3.new(1, 1, 1)
		Lighting.Brightness = 4
	end
end)
